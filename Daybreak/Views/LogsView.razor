<div class="logs-container">
    @if (this.ViewModel.Loading)
    {
        <SpinnerWidget IsLoading=true />
    }
    else
    {
        <div class="title-bar-additional-btns-left">
            <button class="title-bar-btn" @onclick="this.ViewModel.ArchiveLogs" title="Archive logs">
                <FluentIcon Value="new Icons.Regular.Size16.Archive()" />
            </button>
            <button class="title-bar-btn" @onclick="this.ViewModel.ClearLogs" title="Clear logs">
                <FluentIcon Value="new Icons.Regular.Size16.Delete()" />
            </button>
            <button class="title-bar-btn" @onclick="this.ViewModel.ToggleAutoScroll" title="@(this.ViewModel.AutoScroll ? "Disable auto-scroll" : "Enable auto-scroll")">
                @if (this.ViewModel.AutoScroll)
                {
                    <FluentIcon Value="new Icons.Regular.Size16.ArrowDownload()" />
                }
                else
                {
                    <FluentIcon Value="new Icons.Regular.Size16.ArrowDownloadOff()" />
                }
            </button>
        </div>

        <div class="stretch-container backdrop-panel">
            <div class="console-container" id="logs-console-container" tabindex="0">
                <div class="console-output">
                    @foreach (var log in this.ViewModel.Logs)
                    {
                        <div class="console-entry">
                            @foreach(var token in log.Tokens)
                            {
                                switch (token.Type)
                                {
                                    case LogTokenType.NewLine:
                                        <br />
                                        break;
                                    case LogTokenType.Timestamp:
                                        <span class="log-timestamp">@token.Value</span>
                                        break;
                                    case LogTokenType.Level:
                                        <span class="log-level @(this.GetLogLevelClass(log.Log.Level))">@token.Value</span>
                                        break;
                                    case LogTokenType.Message:
                                        <span class="log-message">@token.Value</span>
                                        break;
                                    case LogTokenType.Exception:
                                        <span class="log-exception">@token.Value</span>
                                        break;
                                    case LogTokenType.Property:
                                        <span class="log-property">@token.Value</span>
                                        break;
                                    default:
                                        <span>@token.Value</span>
                                        break;
                                }
                            }
                        </div>
                    }
                </div>

                @if (!this.ViewModel.Logs.Any())
                {
                    <div class="no-logs">
                        <span>No logs available</span>
                    </div>
                }
            </div>
        </div>
    }
</div>

@page "/logs"
@inherits ViewBase<LogsView, LogsViewModel>
@inject IJSRuntime jSRuntime;
@using Serilog.Events
@using static Daybreak.Services.Logging.StructuredLogFormatter
@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        
        if (this.ViewModel.AutoScroll)
        {
            await this.ScrollToBottomAsync();
        }
    }

    private async Task ScrollToBottomAsync()
    {
        try
        {
            await this.jSRuntime.InvokeVoidAsync("eval", 
                "document.getElementById('logs-console-container').scrollTop = document.getElementById('logs-console-container').scrollHeight");
        }
        catch
        {
            
        }
    }

    private string GetLogLevelClass(LogEventLevel level) => level switch
    { 
        LogEventLevel.Information => ".info",
        LogEventLevel.Warning => ".warning",
        LogEventLevel.Error => ".error",
        LogEventLevel.Fatal => ".critical",
        _ => ".default"
    };
}
