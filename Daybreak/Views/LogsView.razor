<div class="logs-container">
    @if (this.ViewModel.Loading)
    {
        <SpinnerWidget IsLoading=true />
    }
    else
    {
        <div class="title-bar-additional-btns-left">
            <button class="title-bar-btn" @onclick="this.ViewModel.ArchiveLogs" title="Archive logs">
                <FluentIcon Value="new Icons.Regular.Size16.Archive()" />
            </button>
            <button class="title-bar-btn" @onclick="this.ViewModel.ClearLogs" title="Clear logs">
                <FluentIcon Value="new Icons.Regular.Size16.Delete()" />
            </button>
            <button class="title-bar-btn" @onclick="this.ViewModel.ToggleAutoScroll" title="@(this.ViewModel.AutoScroll ? "Disable auto-scroll" : "Enable auto-scroll")">
                @if (this.ViewModel.AutoScroll)
                {
                    <FluentIcon Value="new Icons.Regular.Size16.ArrowDownload()" />
                }
                else
                {
                    <FluentIcon Value="new Icons.Regular.Size16.ArrowDownloadOff()" />
                }
            </button>
        </div>

        <div class="stretch-container backdrop-panel">
            <div class="console-container" id="logs-console-container" tabindex="0">
                <div class="console-output">
                    @foreach (var log in this.ViewModel.Logs)
                    {
                        <div class="console-entry @this.GetLogLevelClass(log.Level)">
                            <div class="log-header">
                                <span class="log-timestamp">[@log.Timestamp.ToString("u")]</span>
                                <span class="log-level-badge">[@this.GetLogLevelText(log.Level)]</span>
                            </div>
                            <div class="log-message">@log.MessageTemplate.Render(log.Properties).Trim()</div>
                        </div>
                    }
                </div>

                @if (!this.ViewModel.Logs.Any())
                {
                    <div class="no-logs">
                        <span>No logs available</span>
                    </div>
                }
            </div>
        </div>
    }
</div>

@page "/logs"
@inherits ViewBase<LogsView, LogsViewModel>
@inject IJSRuntime jSRuntime;
@using Serilog.Events
@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        
        if (this.ViewModel.AutoScroll)
        {
            await this.ScrollToBottomAsync();
        }
    }

    private async Task ScrollToBottomAsync()
    {
        try
        {
            await this.jSRuntime.InvokeVoidAsync("eval", 
                "document.getElementById('logs-console-container').scrollTop = document.getElementById('logs-console-container').scrollHeight");
        }
        catch
        {
            
        }
    }

    private string GetLogLevelClass(LogEventLevel level) => level switch
    { 
        LogEventLevel.Information => "log-info",
        LogEventLevel.Warning => "log-warning",
        LogEventLevel.Error => "log-error",
        LogEventLevel.Fatal => "log-critical",
        _ => "log-default"
    };

    private string GetLogLevelText(LogEventLevel level) => level switch
    {
        LogEventLevel.Verbose => "VERB",
        LogEventLevel.Debug => "DEBG",
        LogEventLevel.Information => "INFO",
        LogEventLevel.Warning => "WARN",
        LogEventLevel.Error => "ERRO",
        LogEventLevel.Fatal => "CRIT",
        _ => "????"
    };
}
